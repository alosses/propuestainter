<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Estratega Internacional Bci | Simulador de Propuestas</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --bci-blue: #002D5A;
            --bci-light-blue: #005FFF;
            --bci-cyan: #00B5E2;
            --bci-red: #D62D20;
            --bci-green: #28a745;
            --bci-yellow: #ffc107;
            --bg-gray: #F4F6F9;
            --text-dark: #333;
            --white: #ffffff;
        }

        body {
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-gray);
            color: var(--text-dark);
            margin: 0;
            padding: 0;
        }

        /* Header */
        header {
            background-color: var(--bci-blue);
            color: var(--white);
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 4px solid var(--bci-red);
        }

        header h1 { margin: 0; font-size: 1.5rem; font-weight: 300; }
        header h1 strong { font-weight: 700; }

        /* Container */
        .container {
            max-width: 1200px;
            margin: 2rem auto;
            padding: 0 1rem;
            display: grid;
            grid-template-columns: 1fr;
            gap: 2rem;
        }

        /* Card Styles */
        .card {
            background: var(--white);
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
            padding: 2rem;
            margin-bottom: 1rem;
        }

        .card-header {
            border-bottom: 1px solid #eee;
            padding-bottom: 1rem;
            margin-bottom: 1rem;
            color: var(--bci-blue);
            font-size: 1.2rem;
            font-weight: 700;
        }

        /* Controls Section */
        .controls-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            align-items: end;
        }

        .form-group { display: flex; flex-direction: column; }
        label { font-size: 0.9rem; color: #666; margin-bottom: 0.5rem; font-weight: 600; }
        input[type="number"], select { padding: 0.8rem; border: 1px solid #ddd; border-radius: 4px; font-size: 1rem; width: 100%; box-sizing: border-box; }
        input[type="range"] { width: 100%; }

        /* Dashboard Grid */
        .dashboard-grid {
            display: grid;
            grid-template-columns: 1fr 300px;
            gap: 2rem;
        }
        @media (max-width: 900px) { .dashboard-grid { grid-template-columns: 1fr; } }

        /* Tables */
        table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
        th { background-color: #f8f9fa; color: var(--bci-blue); text-align: left; padding: 0.8rem; font-weight: 600; }
        td { padding: 0.8rem; border-bottom: 1px solid #eee; }
        .row-group-header { background-color: #e9ecef; font-weight: bold; color: var(--bci-blue); }
        .text-right { text-align: right; }
        .text-bci { color: var(--bci-blue); font-weight: bold; }
        .row-rejected { background-color: #fff5f5; opacity: 0.5; color: #999; text-decoration: line-through; }

        /* Switch Toggle */
        .switch { position: relative; display: inline-block; width: 34px; height: 20px; vertical-align: middle; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 14px; width: 14px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--bci-light-blue); }
        input:checked + .slider:before { transform: translateX(14px); }

        /* Charts & Tactics */
        .chart-container { position: relative; height: 250px; width: 100%; }
        .tactical-matrix { display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem; }
        .tactical-item { display: flex; justify-content: space-between; align-items: center; padding: 0.5rem 0; border-bottom: 1px solid #f0f0f0; font-size: 0.9rem; }
        .badge { padding: 0.2rem 0.6rem; border-radius: 12px; font-size: 0.75rem; font-weight: bold; color: white; }
        .bg-green { background-color: var(--bci-green); }
        .bg-yellow { background-color: var(--bci-yellow); color: #444; }
        .bg-red { background-color: var(--bci-red); }

        /* Print */
        @media print {
            .no-print { display: none !important; }
            body { background-color: white; }
            .card { box-shadow: none; border: 1px solid #ddd; }
        }
    </style>
</head>
<body>

<header>
    <div>
        <h1>SOFI/MATTEO <strong>Estrategia Internacional</strong></h1>
        <small style="opacity: 0.8;">Simulador de Propuestas y Redistribuci√≥n</small>
    </div>
    <div class="no-print">
        <button onclick="window.print()" style="background:transparent; border:1px solid white; color:white; padding:5px 15px; cursor:pointer; font-weight:bold; border-radius:4px;">üñ®Ô∏è Imprimir PDF</button>
    </div>
</header>

<div class="container">

    <div class="card no-print">
        <div class="card-header">Configuraci√≥n de la Inversi√≥n</div>
        <div class="controls-grid">
            <div class="form-group">
                <label>Monto a Invertir (USD)</label>
                <input type="number" id="amount" value="100000" min="1000" step="1000" onchange="generateProposal()">
            </div>
            <div class="form-group">
                <label>Perfil de Inversionista</label>
                <select id="profile" onchange="resetAndGenerate()">
                    <option value="muy_agresivo">Muy Agresivo</option>
                    <option value="agresiva">Agresiva</option>
                    <option value="moderada" selected>Moderada</option>
                    <option value="mod_cons">Moderada Conservadora</option>
                    <option value="conservador">Conservador</option>
                </select>
            </div>
            <div class="form-group">
                <label>Fondo de Emergencia / Liquidez: <span id="liq-val" style="color:var(--bci-light-blue)">5%</span></label>
                <input type="range" id="liquidity" min="0" max="50" value="5" step="1" oninput="updateLiqLabel(); generateProposal()">
            </div>
        </div>
    </div>

    <div class="dashboard-grid">
        
        <div>
            
            <div class="card">
                <div class="card-header">
                    <span>1. Selecci√≥n de Portafolio Modelo</span>
                    <small style="font-weight:400; font-size:0.8rem; color:#666;">Acepta o rechaza los fondos sugeridos.</small>
                </div>
                <table id="selection-table">
                    <thead>
                        <tr>
                            <th class="no-print" style="width:50px; text-align:center;">Aceptar</th>
                            <th>Clase de Activo</th>
                            <th>Producto Recomendado</th>
                            <th class="text-right">Peso Base</th>
                            <th class="text-right">Monto Base</th>
                        </tr>
                    </thead>
                    <tbody id="selection-body">
                        </tbody>
                </table>
            </div>

            <div class="card" style="border-top: 4px solid var(--bci-green);">
                <div class="card-header">
                    <span>2. Propuesta Final (Redistribuida)</span>
                    <small style="font-weight:400; font-size:0.8rem; color:#666;">El capital rechazado se ha redistribuido proporcionalmente.</small>
                </div>
                <table id="final-table">
                    <thead>
                        <tr style="background-color: #f0f4f8;">
                            <th>Clase de Activo</th>
                            <th>Producto Definitivo</th>
                            <th class="text-right">Peso Final</th>
                            <th class="text-right">Monto Final</th>
                            <th class="text-right">Ret. 12M</th>
                        </tr>
                    </thead>
                    <tbody id="final-body">
                        </tbody>
                    <tfoot>
                        <tr style="background-color: var(--bci-blue); color: white;">
                            <td colspan="2" class="text-right"><strong>TOTAL CARTERA</strong></td>
                            <td class="text-right"><strong id="total-weight">100%</strong></td>
                            <td class="text-right"><strong id="total-amount">$0</strong></td>
                            <td class="text-right"><small>Esperado:</small> <span id="total-return">-</span></td>
                        </tr>
                    </tfoot>
                </table>

                <div style="margin-top: 2rem; display: flex; align-items: center; gap: 2rem;">
                    <div style="text-align: center;">
                        <h3 id="proj-return-val" style="color:var(--bci-blue); font-size: 2rem; margin:0;">0.0%</h3>
                        <small style="color:#666;">Retorno Esperado Anual</small>
                    </div>
                    <div style="flex-grow: 1; height: 120px;">
                        <canvas id="scenarioChart"></canvas>
                    </div>
                </div>
            </div>

        </div>

        <div class="sidebar">
            <div class="card">
                <div class="card-header">Distribuci√≥n Final</div>
                <div class="chart-container">
                    <canvas id="allocationChart"></canvas>
                </div>
            </div>

            <div class="card tactical-matrix">
                <div class="card-header" style="grid-column: 1 / -1;">Visi√≥n T√°ctica</div>
                
                <div style="grid-column: 1 / -1; font-size:0.8rem; color:#666; font-weight:bold;">RENTA VARIABLE</div>
                <div class="tactical-item"><span>EE.UU.</span> <span class="badge bg-yellow">Neutral</span></div>
                <div class="tactical-item"><span>Europa</span> <span class="badge bg-red">Subpond.</span></div>
                <div class="tactical-item"><span>Jap√≥n</span> <span class="badge bg-yellow">Neutral</span></div>
                <div class="tactical-item"><span>Asia Em.</span> <span class="badge bg-green">Positivo</span></div>
                <div class="tactical-item"><span>Latam</span> <span class="badge bg-green">Positivo</span></div>

                <div style="grid-column: 1 / -1; font-size:0.8rem; color:#666; font-weight:bold; margin-top:1rem;">RENTA FIJA</div>
                <div class="tactical-item"><span>Global IG</span> <span class="badge bg-green">Positivo</span></div>
                <div class="tactical-item"><span>High Yield</span> <span class="badge bg-red">Negativo</span></div>
                <div class="tactical-item"><span>EM Local</span> <span class="badge bg-green">Positivo</span></div>
            </div>
        </div>

    </div>
</div>

<script>
    /* =========================================
       BASE DE DATOS (Focus List y Modelos)
       [cite_start][cite: 1, 66, 142]
       ========================================= */
    
    const PRODUCTS = {
        [cite_start]// Renta Variable [cite: 7-65]
        "us_equity": { name: "Alliance Bernstein Select US", isin: "LU0683600562", m12: 13.99 },
        "europe_equity": { name: "JPM Europe Equity A", isin: "LU0119078227", m12: 29.01 },
        "japan_equity": { name: "M&G (Lux) Japan A", isin: "LU1684384271", m12: 23.79 },
        "global_em": { name: "BSF Emerging Mkts Equity", isin: "LU1289970086", m12: 36.53 },
        "asia_equity": { name: "Schroder ISF Em. Asia", isin: "LU0181495838", m12: 29.15 },
        "latam_equity": { name: "Amundi Latin America", isin: "LU0201575346", m12: 45.91 },
        "chile_equity": { name: "Portafolios Accionarios CDB", isin: "Local", m12: 12.00 },
        
        [cite_start]// Renta Fija [cite: 72-140]
        "global_bond": { name: "MS INV Global Bond", isin: "LU0073230426", m12: 6.15 },
        "em_hard": { name: "MS INV Emerging Mkts Debt", isin: "LU0073230004", m12: 11.72 },
        "em_local": { name: "PIMCO GIS Em. Local Bond", isin: "IE00B3DD5N41", m12: 17.99 },
        "latam_hy_debt": { name: "Ninety One Latam Corp", isin: "LU0492942718", m12: 7.16 },
        "us_flex": { name: "PIMCO GIS Income", isin: "IE00B7KFL990", m12: 8.43 },
        "rf_local": { name: "Bonos Empresas Chilenas", isin: "Local", m12: 6.80 },

        // Liquidez
        "liquidity": { name: "Pimco GIS Low Duration", isin: "IE00BDT57T44", m12: 7.71 }
    };

    [cite_start]// [cite: 142] Asset Allocation basado en imagen proporcionada
    const PROFILES = {
        "muy_agresivo": { alloc: { "us_equity": 38.4, "europe_equity": 4.6, "japan_equity": 3.0, "global_em": 10.1, "asia_equity": 8.3, "latam_equity": 3.1, "chile_equity": 23.5, "global_bond": 5.0, "em_local": 1.4, "latam_hy_debt": 1.8, "us_flex": 5.0, "rf_local": 10.0 } },
        "agresiva": { alloc: { "us_equity": 28.8, "europe_equity": 2.4, "japan_equity": 2.2, "global_em": 6.6, "asia_equity": 6.9, "latam_equity": 2.9, "chile_equity": 18.5, "global_bond": 10.0, "em_hard": 0.8, "em_local": 3.1, "latam_hy_debt": 2.4, "us_flex": 6.0, "rf_local": 25.0 } },
        "moderada": { alloc: { "us_equity": 19.2, "europe_equity": 1.3, "japan_equity": 1.5, "global_em": 3.7, "asia_equity": 4.6, "latam_equity": 1.8, "chile_equity": 12.5, "global_bond": 15.0, "em_hard": 2.2, "em_local": 3.6, "latam_hy_debt": 3.7, "us_flex": 7.3, "rf_local": 42.0 } },
        "mod_cons": { alloc: { "us_equity": 13.4, "europe_equity": 1.0, "japan_equity": 1.0, "global_em": 2.1, "asia_equity": 2.8, "latam_equity": 0.7, "chile_equity": 8.5, "global_bond": 18.0, "em_hard": 3.0, "em_local": 4.0, "latam_hy_debt": 4.4, "rf_local": 53.0 } },
        "conservador": { alloc: { "us_equity": 5.8, "europe_equity": 0.6, "japan_equity": 0.4, "asia_equity": 1.8, "chile_equity": 3.5, "global_bond": 22.0, "em_hard": 4.2, "em_local": 4.4, "latam_hy_debt": 4.7, "rf_local": 65.0 } }
    };

    const GROUP_NAMES = {
        "us_equity": "RV EE.UU.", "europe_equity": "RV Europa", "japan_equity": "RV Jap√≥n",
        "global_em": "RV Emergente Global", "asia_equity": "RV Asia ex-Japan", "latam_equity": "RV Latam",
        "chile_equity": "RV Chile Local", "global_bond": "Deuda Global IG", "em_hard": "Deuda EM (D√≥lar)",
        "em_local": "Deuda EM (Local)", "latam_hy_debt": "Latam High Yield", "us_flex": "Deuda Flexible US",
        "rf_local": "Renta Fija Local"
    };

    let excludedAssets = new Set();
    let chartAlloc = null;
    let chartScen = null;
    const fmtUSD = new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', maximumFractionDigits: 0 });

    /* =========================================
       L√ìGICA
       ========================================= */

    function updateLiqLabel() { document.getElementById('liq-val').textContent = document.getElementById('liquidity').value + "%"; }
    function resetAndGenerate() { excludedAssets.clear(); generateProposal(); }

    function toggleAsset(key) {
        if (excludedAssets.has(key)) excludedAssets.delete(key);
        else excludedAssets.add(key);
        generateProposal();
    }

    function generateProposal() {
        const totalAmount = parseFloat(document.getElementById('amount').value) || 0;
        const profileKey = document.getElementById('profile').value;
        const baseLiqPct = parseFloat(document.getElementById('liquidity').value) / 100;
        const profile = PROFILES[profileKey];

        // 1. Calcular Datos Base (Tabla Superior)
        const baseLiquidity = totalAmount * baseLiqPct;
        const investableAmount = totalAmount - baseLiquidity;

        let map = {};
        let rejectedTotal = 0;
        let activeWeightSum = 0;

        // Iterar sobre el modelo seleccionado
        for (const [key, pct] of Object.entries(profile.alloc)) {
            if (pct <= 0) continue;
            
            const rawAmount = investableAmount * (pct / 100);
            const isRejected = excludedAssets.has(key);
            
            if (isRejected) {
                rejectedTotal += rawAmount;
            } else {
                activeWeightSum += pct; // Sumar pesos de lo que S√ç queremos para prorratear
            }

            map[key] = {
                baseAmount: rawAmount,
                isRejected: isRejected,
                finalAmount: isRejected ? 0 : rawAmount // Inicialmente 0 si rechazado
            };
        }

        renderSelectionTable(map, totalAmount);

        // 2. Redistribuci√≥n (L√≥gica Proporcional)
        // El dinero rechazado se reparte entre los activos aceptados seg√∫n su peso relativo
        
        if (activeWeightSum > 0 && rejectedTotal > 0) {
            for (const key in map) {
                if (!map[key].isRejected) {
                    // Cuota = (PesoOriginal / SumaPesosActivos) * MontoRechazado
                    const share = profile.alloc[key] / activeWeightSum;
                    const boost = rejectedTotal * share;
                    map[key].finalAmount += boost;
                }
            }
        } else if (activeWeightSum === 0) {
            // Si rechaz√≥ todo, todo va a liquidez (√∫nica opci√≥n l√≥gica)
            // baseLiquidity absorber√° rejectedTotal m√°s abajo en el render final
        }

        renderFinalTable(map, baseLiquidity, totalAmount, activeWeightSum === 0 ? rejectedTotal : 0);
    }

    // Tabla 1: Selecci√≥n (Con Switches)
    function renderSelectionTable(map, total) {
        let html = "";
        const orderedKeys = Object.keys(map); // Mantener orden

        orderedKeys.forEach(key => {
            const data = map[key];
            const prod = PRODUCTS[key];
            const weight = (data.baseAmount / total) * 100;
            const rowClass = data.isRejected ? "row-rejected" : "";
            const checked = data.isRejected ? "" : "checked";

            html += `
                <tr class="${rowClass}">
                    <td class="no-print" style="text-align:center;">
                        <label class="switch">
                            <input type="checkbox" ${checked} onchange="toggleAsset('${key}')">
                            <span class="slider"></span>
                        </label>
                    </td>
                    <td>${GROUP_NAMES[key]}</td>
                    <td>${prod.name}</td>
                    <td class="text-right">${weight.toFixed(1)}%</td>
                    <td class="text-right">${fmtUSD.format(data.baseAmount)}</td>
                </tr>
            `;
        });
        document.getElementById('selection-body').innerHTML = html;
    }

    // Tabla 2: Final (Redistribuida)
    function renderFinalTable(map, liqBase, total, extraLiq) {
        let html = "";
        let wRet = 0;
        let chartLabels = [];
        let chartData = [];
        let chartColors = [];

        // Activos
        for (const [key, data] of Object.entries(map)) {
            if (data.isRejected) continue;

            const prod = PRODUCTS[key];
            const w = data.finalAmount / total;
            wRet += (prod.m12 * w);

            // Gr√°fico
            chartLabels.push(GROUP_NAMES[key]);
            chartData.push(data.finalAmount);
            chartColors.push(key.includes("equity") ? "#002D5A" : "#D62D20");

            html += `
                <tr>
                    <td>${GROUP_NAMES[key]}</td>
                    <td>${prod.name}</td>
                    <td class="text-right">${(w*100).toFixed(1)}%</td>
                    <td class="text-right"><strong>${fmtUSD.format(data.finalAmount)}</strong></td>
                    <td class="text-right" style="color:${prod.m12 >= 0 ? 'var(--bci-blue)' : 'red'}">${prod.m12}%</td>
                </tr>
            `;
        }

        // Liquidez Final
        const finalLiq = liqBase + extraLiq;
        const liqProd = PRODUCTS["liquidity"];
        const liqW = finalLiq / total;
        wRet += (liqProd.m12 * liqW);

        chartLabels.push("Liquidez");
        chartData.push(finalLiq);
        chartColors.push("#00B5E2");

        html += `
            <tr style="background-color: #eef9fd; font-weight:bold;">
                <td>Liquidez / Caja</td>
                <td>${liqProd.name}</td>
                <td class="text-right">${(liqW*100).toFixed(1)}%</td>
                <td class="text-right">${fmtUSD.format(finalLiq)}</td>
                <td class="text-right" style="color:var(--bci-blue)">${liqProd.m12}%</td>
            </tr>
        `;

        document.getElementById('final-body').innerHTML = html;
        document.getElementById('total-amount').textContent = fmtUSD.format(total);
        document.getElementById('total-return').textContent = wRet.toFixed(2) + "%";
        document.getElementById('proj-return-val').textContent = wRet.toFixed(2) + "%";

        renderCharts(chartLabels, chartData, chartColors, wRet);
    }

    function renderCharts(l, d, c, ret) {
        // Dona
        const ctxA = document.getElementById('allocationChart').getContext('2d');
        if (chartAlloc) chartAlloc.destroy();
        chartAlloc = new Chart(ctxA, {
            type: 'doughnut',
            data: { labels: l, datasets: [{ data: d, backgroundColor: c, borderWidth: 1 }] },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
        });

        // Barras
        const ctxS = document.getElementById('scenarioChart').getContext('2d');
        if (chartScen) chartScen.destroy();
        chartScen = new Chart(ctxS, {
            type: 'bar',
            data: {
                labels: ['Conservador', 'Base', 'Optimista'],
                datasets: [{
                    label: 'Retorno %',
                    data: [ret*0.6, ret, ret*1.4],
                    backgroundColor: ['#D62D20', '#002D5A', '#28a745'],
                    borderRadius: 4
                }]
            },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true } } }
        });
    }

    // Init
    window.onload = generateProposal;

</script>

</body>
</html>
