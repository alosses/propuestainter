<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Estratega Internacional Bci | Simulador Reasignaci√≥n</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --bci-blue: #002D5A;
            --bci-light-blue: #005FFF;
            --bci-cyan: #00B5E2;
            --bci-red: #D62D20;
            --bci-green: #28a745;
            --bci-yellow: #ffc107;
            --bg-gray: #F4F6F9;
            --text-dark: #333;
            --white: #ffffff;
        }

        body { font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; background-color: var(--bg-gray); color: var(--text-dark); margin: 0; padding: 0; }

        /* Header */
        header { background-color: var(--bci-blue); color: var(--white); padding: 1rem 2rem; display: flex; justify-content: space-between; align-items: center; border-bottom: 4px solid var(--bci-red); }
        header h1 { margin: 0; font-size: 1.5rem; font-weight: 300; }
        header h1 strong { font-weight: 700; }

        /* Container & Grid */
        .container { max-width: 1200px; margin: 2rem auto; padding: 0 1rem; display: grid; gap: 2rem; }
        .dashboard-grid { display: grid; grid-template-columns: 1fr 320px; gap: 2rem; }
        @media (max-width: 900px) { .dashboard-grid { grid-template-columns: 1fr; } }

        /* Cards */
        .card { background: var(--white); border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); padding: 2rem; margin-bottom: 1rem; }
        .card-header { border-bottom: 1px solid #eee; padding-bottom: 1rem; margin-bottom: 1rem; color: var(--bci-blue); font-size: 1.2rem; font-weight: 700; display:flex; justify-content:space-between; align-items:center; }
        .card-sub { font-size: 0.9rem; color: #666; font-weight: 400; }

        /* Controls */
        .controls-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1.5rem; align-items: end; }
        .form-group { display: flex; flex-direction: column; }
        label { font-size: 0.9rem; color: #666; margin-bottom: 0.5rem; font-weight: 600; }
        input[type="number"], select { padding: 0.8rem; border: 1px solid #ddd; border-radius: 4px; font-size: 1rem; width: 100%; box-sizing: border-box; }
        input[type="range"] { width: 100%; }

        /* Reallocation Panel */
        .realloc-panel { background-color: #eef2f7; border-left: 4px solid var(--bci-yellow); padding: 1rem; margin-bottom: 1.5rem; border-radius: 4px; display: flex; align-items: center; justify-content: space-between; gap: 1rem;}
        .realloc-info { font-size: 0.95rem; color: #444; }
        .realloc-amount { font-weight: bold; color: var(--bci-red); font-size: 1.1rem; }

        /* Tables */
        table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
        th { background-color: #f8f9fa; color: var(--bci-blue); text-align: left; padding: 0.8rem; font-weight: 600; }
        td { padding: 0.8rem; border-bottom: 1px solid #eee; vertical-align: middle; }
        .row-group-header { background-color: #e9ecef; font-weight: bold; color: var(--bci-blue); }
        .text-right { text-align: right; }
        .text-bci { color: var(--bci-blue); font-weight: bold; }
        .row-rejected { background-color: #fff5f5; opacity: 0.5; text-decoration: line-through; color: #999; }
        
        /* Final Proposal Table Styles */
        .final-table tr { transition: background 0.3s; }
        .final-table tr:hover { background-color: #f9f9f9; }
        .boosted-val { color: var(--bci-green); font-weight: bold; } /* Valor aumentado por reasignaci√≥n */

        /* Switch */
        .switch { position: relative; display: inline-block; width: 34px; height: 20px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 14px; width: 14px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--bci-light-blue); }
        input:checked + .slider:before { transform: translateX(14px); }

        /* Tactical Matrix */
        .tactical-matrix { display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem; }
        .tactical-item { display: flex; justify-content: space-between; align-items: center; padding: 0.5rem 0; border-bottom: 1px solid #f0f0f0; font-size: 0.9rem; }
        .badge { padding: 0.2rem 0.6rem; border-radius: 12px; font-size: 0.75rem; font-weight: bold; color: white; }
        .bg-green { background-color: var(--bci-green); }
        .bg-yellow { background-color: var(--bci-yellow); color: #444; }
        .bg-red { background-color: var(--bci-red); }

        /* Print */
        @media print {
            .no-print, .controls-grid, .switch { display: none !important; }
            .card { border: 1px solid #ccc; box-shadow: none; }
            body { background: white; }
            .row-rejected { display: none; } /* Ocultar filas rechazadas en impresi√≥n */
        }
    </style>
</head>
<body>

<header>
    <div>
        <h1>BCI <strong>Estrategia Internacional</strong></h1>
        <small style="opacity: 0.9;">Simulador de Propuestas y Reasignaci√≥n V2.0</small>
    </div>
    <div class="no-print">
        <button onclick="window.print()" style="background:transparent; border:1px solid white; color:white; padding:5px 15px; cursor:pointer; font-weight:bold; border-radius:4px;">üñ®Ô∏è Imprimir PDF</button>
    </div>
</header>

<div class="container">

    <div class="card no-print">
        <div class="card-header">
            1. Configuraci√≥n Inicial
            <span class="card-sub">Define el perfil base antes de personalizar</span>
        </div>
        <div class="controls-grid">
            <div class="form-group">
                <label>Monto a Invertir (USD)</label>
                <input type="number" id="amount" value="100000" min="1000" step="1000" onchange="generateProposal()">
            </div>
            <div class="form-group">
                <label>Perfil de Riesgo</label>
                <select id="profile" onchange="handleProfileChange()">
                    <option value="muy_agresivo">Muy Agresivo</option>
                    <option value="agresiva">Agresiva</option>
                    <option value="moderada" selected>Moderada</option>
                    <option value="mod_cons">Moderada Conservadora</option>
                    <option value="conservador">Conservador</option>
                </select>
            </div>
            <div class="form-group">
                <label>Liquidez Base: <span id="liq-val" style="color:var(--bci-light-blue)">5%</span></label>
                <input type="range" id="liquidity" min="0" max="50" value="5" step="1" oninput="updateLiqLabel(); generateProposal()">
            </div>
        </div>
    </div>

    <div class="dashboard-grid">
        
        <div>
            <div class="card">
                <div class="card-header">
                    2. Selecci√≥n de Activos (Base)
                    <span class="card-sub">Desmarca lo que el cliente NO desea</span>
                </div>

                <div class="realloc-panel no-print">
                    <div class="realloc-info">
                        Capital Rechazado: <span id="rejected-display" class="realloc-amount">$0</span>
                    </div>
                    <div style="flex-grow: 1; margin-left: 20px;">
                        <label style="font-size:0.8rem; display:block; margin-bottom:4px;">Estrategia de Reasignaci√≥n:</label>
                        <select id="realloc-strategy" onchange="generateProposal()" style="padding:5px; font-size:0.9rem;">
                            <option value="CASH">1. Mantener en Caja/Liquidez (Default)</option>
                            <option value="PROPORTIONAL" selected>2. Redistribuir Proporcionalmente (Aceptados)</option>
                            <option value="SAFE">3. Asignar a Renta Fija Global (Conservador)</option>
                        </select>
                    </div>
                </div>

                <table id="selection-table">
                    <thead>
                        <tr>
                            <th class="no-print" style="width:50px; text-align:center;">Incluir</th>
                            <th>Clase de Activo</th>
                            <th>Producto Base</th>
                            <th class="text-right">Peso Base</th>
                            <th class="text-right">Monto Base</th>
                        </tr>
                    </thead>
                    <tbody id="selection-body">
                        </tbody>
                </table>
            </div>
        </div>

        <div class="sidebar">
            <div class="card tactical-matrix">
                <div class="card-header" style="grid-column: 1 / -1;">Visi√≥n T√°ctica Bci</div>
                <div class="tactical-item"><span>EE.UU.</span> <span class="badge bg-yellow">Neutral</span></div>
                <div class="tactical-item"><span>Europa</span> <span class="badge bg-red">Subpond.</span></div>
                <div class="tactical-item"><span>Asia Emerg.</span> <span class="badge bg-green">Positivo</span></div>
                <div class="tactical-item"><span>Latam</span> <span class="badge bg-green">Positivo</span></div>
                <div class="tactical-item"><span>Global IG</span> <span class="badge bg-green">Positivo</span></div>
                <div class="tactical-item"><span>High Yield</span> <span class="badge bg-red">Negativo</span></div>
            </div>
            
            <div class="card">
                <div class="card-header">Distribuci√≥n Final</div>
                <div style="height: 200px; position: relative;">
                    <canvas id="allocationChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <div class="card" id="final-proposal-card" style="border-top: 4px solid var(--bci-green);">
        <div class="card-header">
            3. Propuesta Final Ajustada
            <span class="card-sub">Resultado tras aplicar la reasignaci√≥n seleccionada</span>
        </div>
        
        <table class="final-table">
            <thead>
                <tr style="background-color: #f0f4f8;">
                    <th>Clase de Activo</th>
                    <th>Producto Definitivo</th>
                    <th class="text-right">Peso Final %</th>
                    <th class="text-right">Monto Final USD</th>
                    <th class="text-right">Ret. 12M</th>
                </tr>
            </thead>
            <tbody id="final-body">
                </tbody>
            <tfoot>
                <tr style="background-color: var(--bci-blue); color: white;">
                    <td colspan="2" class="text-right"><strong>TOTAL CARTERA FINAL</strong></td>
                    <td class="text-right"><strong id="final-total-weight">100%</strong></td>
                    <td class="text-right"><strong id="final-total-amount">$0</strong></td>
                    <td class="text-right"><span id="final-total-return">-</span></td>
                </tr>
            </tfoot>
        </table>

        <div style="display:flex; justify-content:space-between; margin-top:20px; align-items:center;">
            <div style="width: 40%;">
                <h3 id="proj-return-val" style="color:var(--bci-blue); margin:0; font-size:2rem;">0.0%</h3>
                <small>Retorno Esperado Ponderado (12M)</small>
            </div>
            <div style="width: 58%; height: 150px;">
                <canvas id="scenarioChart"></canvas>
            </div>
        </div>
    </div>

</div>

<script>
    /* =========================================
       BASE DE DATOS
       ========================================= */
    const PRODUCTS = {
        "us_equity": { name: "Alliance Bernstein Select US", isin: "LU0683600562", m12: 13.99 },
        "europe_equity": { name: "JPM Europe Equity A", isin: "LU0119078227", m12: 29.01 },
        "japan_equity": { name: "M&G (Lux) Japan A", isin: "LU1684384271", m12: 23.79 },
        "global_em": { name: "BSF Emerging Mkts Equity", isin: "LU1289970086", m12: 36.53 },
        "asia_equity": { name: "Schroder ISF Em. Asia", isin: "LU0181495838", m12: 29.15 },
        "latam_equity": { name: "Amundi Latin America", isin: "LU0201575346", m12: 45.91 },
        "chile_equity": { name: "Portafolios Accionarios CDB", isin: "Local", m12: 12.00 },
        "global_bond": { name: "MS INV Global Bond", isin: "LU0073230426", m12: 6.15 },
        "em_hard": { name: "MS INV Emerging Mkts Debt", isin: "LU0073230004", m12: 11.72 },
        "em_local": { name: "PIMCO GIS Em. Local Bond", isin: "IE00B3DD5N41", m12: 17.99 },
        "latam_hy_debt": { name: "Ninety One Latam Corp", isin: "LU0492942718", m12: 7.16 },
        "us_flex": { name: "PIMCO GIS Income", isin: "IE00B7KFL990", m12: 8.43 },
        "rf_local": { name: "Bonos Empresas Chilenas", isin: "Local", m12: 6.80 },
        "liquidity": { name: "Pimco GIS Low Duration", isin: "IE00BDT57T44", m12: 7.71 }
    };

    const PROFILES = {
        "muy_agresivo": { label: "Muy Agresivo", alloc: { "us_equity": 38.4, "europe_equity": 4.6, "japan_equity": 3.0, "global_em": 10.1, "asia_equity": 8.3, "latam_equity": 3.1, "chile_equity": 23.5, "global_bond": 5.0, "em_local": 1.4, "us_flex": 5.0, "rf_local": 10.0 } },
        "agresiva": { label: "Agresiva", alloc: { "us_equity": 28.8, "europe_equity": 2.4, "japan_equity": 2.2, "global_em": 6.6, "asia_equity": 6.9, "latam_equity": 2.9, "chile_equity": 18.5, "global_bond": 10.0, "em_hard": 0.8, "em_local": 3.1, "us_flex": 6.0, "rf_local": 25.0 } },
        "moderada": { label: "Moderada", alloc: { "us_equity": 19.2, "europe_equity": 1.3, "japan_equity": 1.5, "global_em": 3.7, "asia_equity": 4.6, "latam_equity": 1.8, "chile_equity": 12.5, "global_bond": 15.0, "em_hard": 2.2, "em_local": 3.6, "latam_hy_debt": 3.7, "us_flex": 7.3, "rf_local": 42.0 } },
        "mod_cons": { label: "Moderada Conservadora", alloc: { "us_equity": 13.4, "europe_equity": 1.0, "chile_equity": 8.5, "global_bond": 18.0, "em_hard": 3.0, "em_local": 4.0, "latam_hy_debt": 4.4, "rf_local": 53.0 } },
        "conservador": { label: "Conservador", alloc: { "us_equity": 5.8, "chile_equity": 3.5, "global_bond": 22.0, "em_hard": 4.2, "rf_local": 65.0 } }
    };

    const GROUP_NAMES = {
        "us_equity": "RV EE.UU.", "europe_equity": "RV Europa", "japan_equity": "RV Jap√≥n",
        "global_em": "RV Emergente Global", "asia_equity": "RV Asia ex-Japan", "latam_equity": "RV Latam",
        "chile_equity": "RV Chile", "global_bond": "Deuda Global IG", "em_hard": "Deuda EM (D√≥lar)",
        "em_local": "Deuda EM (Local)", "latam_hy_debt": "Latam High Yield", "us_flex": "Deuda Flexible US",
        "rf_local": "Renta Fija Local"
    };

    // --- VARIABLES DE ESTADO ---
    let excludedAssets = new Set();
    let chartAlloc = null;
    let chartScen = null;
    const fmtUSD = new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', maximumFractionDigits: 0 });

    // --- UTILS ---
    function updateLiqLabel() { document.getElementById('liq-val').textContent = document.getElementById('liquidity').value + "%"; }
    function handleProfileChange() { excludedAssets.clear(); generateProposal(); }
    function toggleAsset(key) {
        if (excludedAssets.has(key)) excludedAssets.delete(key);
        else excludedAssets.add(key);
        generateProposal();
    }
    function getReturnColor(val) { return val >= 0 ? 'text-bci' : 'text-red'; }

    // --- CORE LOGIC ---
    function generateProposal() {
        const totalAmount = parseFloat(document.getElementById('amount').value) || 0;
        const profileKey = document.getElementById('profile').value;
        const baseLiqPct = parseFloat(document.getElementById('liquidity').value) / 100;
        const strategy = document.getElementById('realloc-strategy').value; // CASH, PROPORTIONAL, SAFE

        const profile = PROFILES[profileKey];
        const baseLiquidity = totalAmount * baseLiqPct;
        const investableAmount = totalAmount - baseLiquidity;

        // 1. Calcular Montos Base y Detectar Rechazos
        let allocationMap = {}; // key -> { baseAmount, isRejected, finalAmount }
        let rejectedTotal = 0;
        let activeWeightSum = 0; // Suma de pesos de activos NO rechazados (para prorrateo)

        // Inicializar mapa con el perfil
        for (const [key, pct] of Object.entries(profile.alloc)) {
            const rawAmount = investableAmount * (pct / 100);
            const isRejected = excludedAssets.has(key);
            
            if (isRejected) {
                rejectedTotal += rawAmount;
            } else {
                activeWeightSum += pct; // Sumar % original para base de prorrateo
            }

            allocationMap[key] = {
                baseAmount: rawAmount,
                isRejected: isRejected,
                finalAmount: isRejected ? 0 : rawAmount // Default start
            };
        }

        // 2. Renderizar Tabla de Selecci√≥n (Parte Superior)
        renderSelectionTable(allocationMap, profile.alloc, totalAmount);

        // 3. Aplicar L√≥gica de Reasignaci√≥n (Parte Inferior)
        document.getElementById('rejected-display').textContent = fmtUSD.format(rejectedTotal);

        // -- LOGICA REDISTRIBUCION --
        let redistributedLiquidity = baseLiquidity; // Empezamos con la base
        
        if (rejectedTotal > 0) {
            if (strategy === 'CASH') {
                // Todo a caja
                redistributedLiquidity += rejectedTotal;
            } else if (strategy === 'PROPORTIONAL') {
                // Repartir entre los aceptados
                for (const key in allocationMap) {
                    if (!allocationMap[key].isRejected) {
                        // Cu√°nto representa este activo del total activo?
                        // activeWeightSum es la suma de los % originales aceptados.
                        // Ejemplo: Aceptados suman 80%. Este activo era 10%. Su peso relativo es 10/80 = 0.125
                        const weightShare = profile.alloc[key] / activeWeightSum;
                        const boost = rejectedTotal * weightShare;
                        allocationMap[key].finalAmount += boost;
                        allocationMap[key].boosted = true; // Flag para UI
                    }
                }
            } else if (strategy === 'SAFE') {
                // Todo a Global Bond (si existe en perfil, o forzarlo)
                if (allocationMap['global_bond'] && !allocationMap['global_bond'].isRejected) {
                    allocationMap['global_bond'].finalAmount += rejectedTotal;
                    allocationMap['global_bond'].boosted = true;
                } else {
                    // Si Global Bond no est√° o fue rechazado, fallback a Caja
                    redistributedLiquidity += rejectedTotal;
                }
            }
        }

        // 4. Renderizar Tabla Final y Gr√°ficos
        renderFinalTable(allocationMap, redistributedLiquidity, totalAmount);
    }

    function renderSelectionTable(map, allocProfile, totalAmount) {
        let html = "";
        for (const [key, data] of Object.entries(map)) {
            const prod = PRODUCTS[key];
            const weight = (data.baseAmount / totalAmount) * 100;
            const checked = data.isRejected ? "" : "checked";
            const rowClass = data.isRejected ? "row-rejected" : "";

            html += `
                <tr class="${rowClass}">
                    <td class="no-print" style="text-align:center;">
                        <label class="switch">
                            <input type="checkbox" ${checked} onchange="toggleAsset('${key}')">
                            <span class="slider"></span>
                        </label>
                    </td>
                    <td>${GROUP_NAMES[key]}</td>
                    <td>${prod.name}</td>
                    <td class="text-right">${weight.toFixed(1)}%</td>
                    <td class="text-right">${fmtUSD.format(data.baseAmount)}</td>
                </tr>
            `;
        }
        document.getElementById('selection-body').innerHTML = html;
    }

    function renderFinalTable(map, finalLiquidity, totalAmount) {
        let html = "";
        let weightedReturn = 0;
        let chartLabels = [], chartData = [], chartColors = [];

        // Activos de Inversi√≥n
        for (const [key, data] of Object.entries(map)) {
            if (data.isRejected) continue; // No mostrar en tabla final

            const prod = PRODUCTS[key];
            const finalWeight = data.finalAmount / totalAmount;
            weightedReturn += (prod.m12 * finalWeight);

            // Chart Data
            chartLabels.push(GROUP_NAMES[key]);
            chartData.push(data.finalAmount);
            chartColors.push(key.includes("equity") ? "#002D5A" : "#D62D20");

            // UI Styles
            const boostClass = data.boosted ? "boosted-val" : "";
            const displayAmount = fmtUSD.format(data.finalAmount);

            html += `
                <tr>
                    <td>${GROUP_NAMES[key]}</td>
                    <td>${prod.name}</td>
                    <td class="text-right">${(finalWeight*100).toFixed(1)}%</td>
                    <td class="text-right ${boostClass}">${displayAmount} ${data.boosted ? '‚Üë' : ''}</td>
                    <td class="text-right ${getReturnColor(prod.m12)}">${prod.m12}%</td>
                </tr>
            `;
        }

        // Fila Liquidez Final
        const prodLiq = PRODUCTS["liquidity"];
        const liqWeight = finalLiquidity / totalAmount;
        weightedReturn += (prodLiq.m12 * liqWeight);

        chartLabels.push("Liquidez Total");
        chartData.push(finalLiquidity);
        chartColors.push("#00B5E2");

        html += `
            <tr style="background-color: #eef9fd; font-weight:bold;">
                <td>Liquidez / Caja</td>
                <td>${prodLiq.name}</td>
                <td class="text-right">${(liqWeight*100).toFixed(1)}%</td>
                <td class="text-right">${fmtUSD.format(finalLiquidity)}</td>
                <td class="text-right text-bci">${prodLiq.m12}%</td>
            </tr>
        `;

        document.getElementById('final-body').innerHTML = html;
        document.getElementById('final-total-amount').textContent = fmtUSD.format(totalAmount);
        document.getElementById('final-total-return').textContent = weightedReturn.toFixed(2) + "%";
        document.getElementById('proj-return-val').textContent = weightedReturn.toFixed(2) + "%";

        // Render Charts
        renderCharts(chartLabels, chartData, chartColors, weightedReturn);
    }

    function renderCharts(labels, data, colors, ret) {
        // Alloc Chart
        const ctxA = document.getElementById('allocationChart').getContext('2d');
        if (chartAlloc) chartAlloc.destroy();
        chartAlloc = new Chart(ctxA, {
            type: 'doughnut',
            data: { labels: labels, datasets: [{ data: data, backgroundColor: colors }] },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
        });

        // Scenario Chart
        const ctxS = document.getElementById('scenarioChart').getContext('2d');
        if (chartScen) chartScen.destroy();
        chartScen = new Chart(ctxS, {
            type: 'bar',
            data: {
                labels: ['Pesimista (-1œÉ)', 'Base', 'Optimista (+1œÉ)'],
                datasets: [{
                    label: 'Retorno Proyectado',
                    data: [ret*0.6, ret, ret*1.4],
                    backgroundColor: ['#D62D20', '#002D5A', '#28a745'],
                    borderRadius: 4
                }]
            },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
        });
    }

    window.onload = generateProposal;
</script>

</body>
</html>