<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Estratega Internacional Sofi | Simulador de Propuestas</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --bci-blue: #002D5A;
            --bci-light-blue: #005FFF;
            --bci-cyan: #00B5E2;
            --bci-red: #D62D20;
            --bci-green: #28a745;
            --bci-yellow: #ffc107;
            --bg-gray: #F4F6F9;
            --text-dark: #333;
            --white: #ffffff;
        }

        body { font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; background-color: var(--bg-gray); color: var(--text-dark); margin: 0; padding: 0; }

        /* Header */
        header { background-color: var(--bci-blue); color: var(--white); padding: 1rem 2rem; display: flex; justify-content: space-between; align-items: center; border-bottom: 4px solid var(--bci-red); }
        header h1 { margin: 0; font-size: 1.5rem; font-weight: 300; }
        header h1 strong { font-weight: 700; }

        /* Container */
        .container { max-width: 1200px; margin: 2rem auto; padding: 0 1rem; display: grid; grid-template-columns: 1fr; gap: 2rem; }

        /* Card Styles */
        .card { background: var(--white); border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); padding: 2rem; margin-bottom: 1rem; }
        .card-header { border-bottom: 1px solid #eee; padding-bottom: 1rem; margin-bottom: 1rem; color: var(--bci-blue); font-size: 1.2rem; font-weight: 700; display:flex; justify-content:space-between; }

        /* Controls Section */
        .controls-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem; align-items: end; }
        .form-group { display: flex; flex-direction: column; }
        label { font-size: 0.9rem; color: #666; margin-bottom: 0.5rem; font-weight: 600; }
        input[type="number"], select { padding: 0.8rem; border: 1px solid #ddd; border-radius: 4px; font-size: 1rem; width: 100%; box-sizing: border-box; }
        input[type="range"] { width: 100%; }
        
        /* Dashboard Grid */
        .dashboard-grid { display: grid; grid-template-columns: 1fr 300px; gap: 2rem; }
        @media (max-width: 900px) { .dashboard-grid { grid-template-columns: 1fr; } }

        /* Tactical View Matrix (Estilo Original) */
        .tactical-matrix { display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem; }
        .tactical-item { display: flex; justify-content: space-between; align-items: center; padding: 0.5rem 0; border-bottom: 1px solid #f0f0f0; font-size: 0.9rem; }
        .badge { padding: 0.2rem 0.6rem; border-radius: 12px; font-size: 0.75rem; font-weight: bold; color: white; }
        .bg-green { background-color: var(--bci-green); }
        .bg-yellow { background-color: var(--bci-yellow); color: #444; }
        .bg-red { background-color: var(--bci-red); }

        /* Tables & Switch */
        table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
        th { background-color: #f8f9fa; color: var(--bci-blue); text-align: left; padding: 0.8rem; font-weight: 600; }
        td { padding: 0.8rem; border-bottom: 1px solid #eee; vertical-align: middle; }
        .row-group-header { background-color: #e9ecef; font-weight: bold; color: var(--bci-blue); }
        .text-right { text-align: right; }
        .text-bci { color: var(--bci-blue); font-weight: bold; }
        .text-muted { color: #999; text-decoration: line-through; }
        .row-rejected { background-color: #fdf2f2; opacity: 0.7; }

        /* Toggle Switch Styling */
        .switch { position: relative; display: inline-block; width: 34px; height: 20px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 14px; width: 14px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--bci-light-blue); }
        input:checked + .slider:before { transform: translateX(14px); }

        /* Chart Container */
        .chart-container { position: relative; height: 250px; width: 100%; }

        /* Print Styles */
        @media print {
            body { background-color: white; }
            header { background-color: white; color: var(--bci-blue); border-bottom: 2px solid var(--bci-blue); }
            .no-print, .controls-grid { display: none; }
            .container { margin: 0; width: 100%; max-width: 100%; }
            .card { box-shadow: none; border: 1px solid #ddd; page-break-inside: avoid; }
            .dashboard-grid { display: block; }
            .tactical-matrix { display: none; } 
            .switch { display: none; } /* Ocultar botones al imprimir */
        }
    </style>
</head>
<body>

<header>
    <div>
        <h1>Sofi/Matteo <strong>Estrategia Internacional</strong></h1>
        <small style="opacity: 0.8;">Cartera Propuesta V1.2 - Con Selecci√≥n Activa</small>
    </div>
    <div class="no-print" style="text-align: right;">
        <button onclick="window.print()" style="background:transparent; border:1px solid white; color:white; padding:5px 15px; cursor:pointer; font-weight:bold; border-radius:4px;">üñ®Ô∏è Imprimir Propuesta</button>
    </div>
</header>

<div class="container">

    <div class="card no-print">
        <div class="card-header">
            <span>Configuraci√≥n de la Inversi√≥n</span>
            <small style="font-weight:400; font-size:0.9rem; color:#666">Define el monto y perfil, luego activa/desactiva fondos abajo.</small>
        </div>
        <div class="controls-grid">
            <div class="form-group">
                <label for="amount">Monto a Invertir (USD)</label>
                <input type="number" id="amount" value="100000" min="1000" step="1000" onchange="generateProposal()">
            </div>
            <div class="form-group">
                <label for="profile">Perfil de Inversionista</label>
                <select id="profile" onchange="handleProfileChange()">
                    <option value="muy_agresivo">Muy Agresivo</option>
                    <option value="agresiva">Agresiva</option>
                    <option value="moderada" selected>Moderada</option>
                    <option value="mod_cons">Moderada Conservadora</option>
                    <option value="conservador">Conservador</option>
                </select>
            </div>
            <div class="form-group">
                <label for="liquidity">Liquidez Base (Emergencia): <span id="liq-val" style="color:var(--bci-light-blue)">5%</span></label>
                <input type="range" id="liquidity" min="0" max="50" value="5" step="1" oninput="updateLiqLabel(); generateProposal()">
            </div>
        </div>
    </div>

    <div class="dashboard-grid">
        
        <div style="width:100%">
            <div class="card" id="proposal-section">
                <div class="card-header">
                    <span>Detalle de Portafolio Sugerido</span>
                    <span id="header-profile-name" style="font-weight:400; color:#666;">Moderada</span>
                </div>
                <table id="proposal-table">
                    <thead>
                        <tr>
                            <th class="no-print" style="width:50px; text-align:center;">Incluir</th>
                            <th>Clase de Activo</th>
                            <th>Producto Recomendado (Focus List)</th>
                            <th class="text-right">Peso %</th>
                            <th class="text-right">Monto USD</th>
                            <th class="text-right">Ret. 12M</th>
                        </tr>
                    </thead>
                    <tbody id="table-body">
                        </tbody>
                    <tfoot>
                        <tr style="background-color: var(--bci-blue); color: white;">
                            <td class="no-print"></td>
                            <td colspan="2" class="text-right"><strong>TOTAL CARTERA</strong></td>
                            <td class="text-right"><strong id="total-weight">100%</strong></td>
                            <td class="text-right"><strong id="total-amount">$0</strong></td>
                            <td class="text-right"><small>Prom. Pond.</small> <span id="total-return">-</span></td>
                        </tr>
                    </tfoot>
                </table>
                <div style="margin-top: 1rem; font-size: 0.8rem; color: #666;">
                    * <strong>Nota:</strong> Si desmarcas un fondo ("Incluir"), el monto asignado se transferir√° autom√°ticamente al Fondo de Liquidez para preservar el capital total.
                </div>
            </div>

            <div class="card">
                <div class="card-header">Proyecci√≥n de Escenarios (12 Meses)</div>
                <div style="display: flex; gap: 2rem; align-items:center;">
                    <div style="flex:1; text-align:center;">
                         <h3 id="projected-return" style="color:var(--bci-blue); font-size: 2.5rem; margin: 0.5rem 0;">0.0%</h3>
                         <span style="color:gray; font-size:0.9rem;">Retorno Esperado Anualizado</span>
                         <p style="font-size:0.8rem; color:#888; margin-top:10px;">Basado en retornos hist√≥ricos 12M ponderados por la selecci√≥n actual.</p>
                    </div>
                    <div style="flex:2;">
                        <canvas id="scenarioChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <div class="sidebar">
            <div class="card">
                <div class="card-header">Distribuci√≥n de Activos</div>
                <div class="chart-container">
                    <canvas id="allocationChart"></canvas>
                </div>
                <div style="text-align:center; margin-top:10px; font-size:0.9rem; color:#666;">
                    Liquidez Total: <strong id="sidebar-liq-amount">$0</strong>
                </div>
            </div>

            <div class="card tactical-matrix">
                <div class="card-header" style="grid-column: 1 / -1;">Visi√≥n T√°ctica (House View)</div>
                
                <div style="grid-column: 1 / -1; font-size:0.8rem; color:#666; margin-bottom:0.5rem; font-weight:bold;">RENTA VARIABLE</div>
                <div class="tactical-item">
                    <span>EE.UU.</span> <span class="badge bg-yellow">Neutral</span>
                </div>
                <div class="tactical-item">
                    <span>Europa</span> <span class="badge bg-red">Subpond.</span>
                </div>
                <div class="tactical-item">
                    <span>Jap√≥n</span> <span class="badge bg-yellow">Neutral</span>
                </div>
                <div class="tactical-item">
                    <span>Asia Emerg.</span> <span class="badge bg-green">Positivo</span>
                </div>
                <div class="tactical-item">
                    <span>Latam</span> <span class="badge bg-green">Positivo</span>
                </div>

                <div style="grid-column: 1 / -1; font-size:0.8rem; color:#666; margin-bottom:0.5rem; margin-top:1rem; font-weight:bold;">RENTA FIJA</div>
                <div class="tactical-item">
                    <span>Global IG</span> <span class="badge bg-green">Positivo</span>
                </div>
                <div class="tactical-item">
                    <span>High Yield</span> <span class="badge bg-red">Negativo</span>
                </div>
                <div class="tactical-item">
                    <span>EM Local</span> <span class="badge bg-green">Positivo</span>
                </div>
                <div class="tactical-item">
                    <span>Latam HY</span> <span class="badge bg-green">Positivo</span>
                </div>
            </div>
        </div>

    </div>
</div>

<script>
    /* =========================================
       BASE DE DATOS (Extra√≠da de Archivos TXT)
       ========================================= */
    const PRODUCTS = {
        // Renta Variable 
        "us_equity": { name: "Alliance Bernstein Select U.S. Equity", isin: "LU0683600562", m12: 13.99 },
        "europe_equity": { name: "JPM Europe Equity A (acc)", isin: "LU0119078227", m12: 29.01 },
        "japan_equity": { name: "M&G (Lux) Japan A USD", isin: "LU1684384271", m12: 23.79 },
        "global_em": { name: "BSF Emerging Markets Equity", isin: "LU1289970086", m12: 36.53 },
        "asia_equity": { name: "Schroder ISF Emerging Asia", isin: "LU0181495838", m12: 29.15 },
        "latam_equity": { name: "Amundi Latin America", isin: "LU0201575346", m12: 45.91 },
        "chile_equity": { name: "Portafolios Accionarios CDB", isin: "N/A - Local", m12: 12.00 },
        
        // Renta Fija 
        "global_bond": { name: "MS INV Global Bond A", isin: "LU0073230426", m12: 6.15 },
        "em_hard": { name: "MS INV Emerging Markets Debt", isin: "LU0073230004", m12: 11.72 },
        "em_local": { name: "PIMCO GIS Emerging Local Bond", isin: "IE00B3DD5N41", m12: 17.99 },
        "latam_hy_debt": { name: "Ninety One GSF Latam Corp. Debt", isin: "LU0492942718", m12: 7.16 },
        "us_flex": { name: "PIMCO GIS Income E USD", isin: "IE00B7KFL990", m12: 8.43 },
        "rf_local": { name: "Bonos de Empresas Chilenas", isin: "N/A - Local", m12: 6.80 },

        // Liquidez
        "liquidity": { name: "Pimco GIS Low Duration Income", isin: "IE00BDT57T44", m12: 7.71 }
    };

    const PROFILES = {
        "muy_agresivo": { label: "Muy Agresivo", alloc: { "us_equity": 38.4, "europe_equity": 4.6, "japan_equity": 3.0, "global_em": 10.1, "asia_equity": 8.3, "latam_equity": 3.1, "chile_equity": 23.5, "global_bond": 5.0, "em_local": 1.4, "latam_hy_debt": 1.8, "us_flex": 5.0, "rf_local": 10.0 } },
        "agresiva": { label: "Agresiva", alloc: { "us_equity": 28.8, "europe_equity": 2.4, "japan_equity": 2.2, "global_em": 6.6, "asia_equity": 6.9, "latam_equity": 2.9, "chile_equity": 18.5, "global_bond": 10.0, "em_hard": 0.8, "em_local": 3.1, "latam_hy_debt": 2.4, "us_flex": 6.0, "rf_local": 25.0 } },
        "moderada": { label: "Moderada", alloc: { "us_equity": 19.2, "europe_equity": 1.3, "japan_equity": 1.5, "global_em": 3.7, "asia_equity": 4.6, "latam_equity": 1.8, "chile_equity": 12.5, "global_bond": 15.0, "em_hard": 2.2, "em_local": 3.6, "latam_hy_debt": 3.7, "us_flex": 7.3, "rf_local": 42.0 } },
        "mod_cons": { label: "Moderada Conservadora", alloc: { "us_equity": 13.4, "europe_equity": 1.0, "japan_equity": 1.0, "global_em": 2.1, "asia_equity": 2.8, "latam_equity": 0.7, "chile_equity": 8.5, "global_bond": 18.0, "em_hard": 3.0, "em_local": 4.0, "latam_hy_debt": 4.4, "rf_local": 53.0 } },
        "conservador": { label: "Conservador", alloc: { "us_equity": 5.8, "europe_equity": 0.6, "japan_equity": 0.4, "asia_equity": 1.8, "chile_equity": 3.5, "global_bond": 22.0, "em_hard": 4.2, "em_local": 4.4, "latam_hy_debt": 4.7, "rf_local": 65.0 } }
    };

    // --- VARIABLES DE ESTADO ---
    let excludedAssets = new Set(); // Guarda las keys que el usuario desmarca
    let allocationChartInstance = null;
    let scenarioChartInstance = null;
    const fmtUSD = new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', maximumFractionDigits: 0 });

    // --- FUNCIONES DE CONTROL ---

    function updateLiqLabel() {
        document.getElementById('liq-val').textContent = document.getElementById('liquidity').value + "%";
    }

    function handleProfileChange() {
        excludedAssets.clear(); // Limpiamos las exclusiones al cambiar de perfil para evitar confusiones
        generateProposal();
    }

    function toggleAsset(key) {
        if (excludedAssets.has(key)) {
            excludedAssets.delete(key);
        } else {
            excludedAssets.add(key);
        }
        generateProposal();
    }

    // --- L√ìGICA PRINCIPAL ---

    function generateProposal() {
        // 1. Obtener Inputs
        const totalAmount = parseFloat(document.getElementById('amount').value) || 0;
        const profileKey = document.getElementById('profile').value;
        const liqPercent = parseFloat(document.getElementById('liquidity').value) / 100;
        const profile = PROFILES[profileKey];

        document.getElementById('header-profile-name').textContent = profile.label;

        // 2. C√°lculos Iniciales
        const baseLiquidityAmount = totalAmount * liqPercent; // Lo que el usuario defini√≥ como "Fondo Emergencia"
        const investableAmount = totalAmount - baseLiquidityAmount; // El resto se distribuye seg√∫n perfil

        // 3. Iterar y Construir
        let tableHTML = "";
        let rejectedAmount = 0; // Acumula el dinero de fondos rechazados
        let weightedReturnSum = 0;
        let chartLabels = [];
        let chartData = [];
        let chartColors = [];

        const groups = {
            "Renta Variable": ["us_equity", "europe_equity", "japan_equity", "global_em", "asia_equity", "latam_equity", "chile_equity"],
            "Renta Fija": ["global_bond", "em_hard", "em_local", "latam_hy_debt", "us_flex", "rf_local"]
        };

        // Procesar Grupos de Inversi√≥n
        for (const [groupName, keys] of Object.entries(groups)) {
            let groupRows = "";
            let hasItems = false;

            keys.forEach(key => {
                if (profile.alloc[key] && profile.alloc[key] > 0) {
                    hasItems = true;
                    const prod = PRODUCTS[key];
                    const rawAllocWeight = profile.alloc[key] / 100; // % del perfil (sobre la parte invertible)
                    const potentialAmount = investableAmount * rawAllocWeight; // Monto si estuviera activo

                    const isExcluded = excludedAssets.has(key);
                    
                    let finalAmount = 0;
                    if (isExcluded) {
                        rejectedAmount += potentialAmount; // Se va a caja
                        finalAmount = 0;
                    } else {
                        finalAmount = potentialAmount;
                    }

                    const finalWeightInTotal = finalAmount / totalAmount;
                    
                    if (!isExcluded) {
                        weightedReturnSum += (prod.m12 * finalWeightInTotal);
                        chartLabels.push(formatKey(key));
                        chartData.push(finalAmount);
                        chartColors.push(groupName === "Renta Variable" ? "#002D5A" : "#D62D20");
                    }

                    // Renderizar Fila
                    const checkedState = isExcluded ? "" : "checked";
                    const rowClass = isExcluded ? "row-rejected" : "";
                    const amountText = isExcluded ? `<span class="text-muted">${fmtUSD.format(potentialAmount)}</span>` : `<strong>${fmtUSD.format(finalAmount)}</strong>`;
                    const weightText = isExcluded ? `<span class="text-muted">0.0%</span>` : `${(finalWeightInTotal*100).toFixed(1)}%`;

                    groupRows += `
                        <tr class="${rowClass}">
                            <td class="no-print" style="text-align:center;">
                                <label class="switch">
                                    <input type="checkbox" ${checkedState} onchange="toggleAsset('${key}')">
                                    <span class="slider"></span>
                                </label>
                            </td>
                            <td>${formatKey(key)}</td>
                            <td>${prod.name}</td>
                            <td class="text-right">${weightText}</td>
                            <td class="text-right">${amountText}</td>
                            <td class="text-right ${getReturnColor(prod.m12)}">${prod.m12}%</td>
                        </tr>
                    `;
                }
            });

            if (hasItems) {
                tableHTML += `<tr class="row-group-header"><td class="no-print"></td><td colspan="5">${groupName}</td></tr>`;
                tableHTML += groupRows;
            }
        }

        // 4. Procesar Liquidez Final (Base + Rechazada)
        const totalLiquidity = baseLiquidityAmount + rejectedAmount;
        const liqProduct = PRODUCTS["liquidity"];
        const liqWeight = totalLiquidity / totalAmount;

        weightedReturnSum += (liqProduct.m12 * liqWeight);

        // Agregar fila Liquidez
        tableHTML += `<tr class="row-group-header"><td class="no-print"></td><td colspan="5">Liquidez / Caja</td></tr>`;
        tableHTML += `
            <tr style="background-color: #f0f8ff;">
                <td class="no-print"></td>
                <td>Money Market / Caja</td>
                <td>${liqProduct.name} <br><small style="color:#666">Incluye rechazos</small></td>
                <td class="text-right"><strong>${(liqWeight*100).toFixed(1)}%</strong></td>
                <td class="text-right"><strong>${fmtUSD.format(totalLiquidity)}</strong></td>
                <td class="text-right text-bci">${liqProduct.m12}%</td>
            </tr>
        `;

        // Datos Gr√°fico
        chartLabels.push("Liquidez");
        chartData.push(totalLiquidity);
        chartColors.push("#00B5E2");

        // 5. Actualizar DOM
        document.getElementById('table-body').innerHTML = tableHTML;
        document.getElementById('total-amount').textContent = fmtUSD.format(totalAmount);
        document.getElementById('total-return').textContent = weightedReturnSum.toFixed(2) + "%";
        document.getElementById('projected-return').textContent = weightedReturnSum.toFixed(2) + "%";
        document.getElementById('sidebar-liq-amount').textContent = fmtUSD.format(totalLiquidity);

        // 6. Charts
        renderAllocationChart(chartLabels, chartData, chartColors);
        renderScenarioChart(weightedReturnSum);
    }

    /* =========================================
       UTILIDADES GR√ÅFICAS
       ========================================= */

    function formatKey(key) {
        const map = {
            "us_equity": "US Large Cap", "europe_equity": "Europa", "japan_equity": "Jap√≥n",
            "global_em": "Global Emerging", "asia_equity": "Asia ex-Japan", "latam_equity": "Latam",
            "chile_equity": "Chile", "global_bond": "Global Bond", "em_hard": "Deuda EM (D√≥lar)",
            "em_local": "Deuda EM (Local)", "latam_hy_debt": "Latam High Yield", "us_flex": "US Flexible Bond",
            "rf_local": "Renta Fija Local"
        };
        return map[key] || key;
    }

    function getReturnColor(val) { return val >= 0 ? 'text-bci' : 'text-red'; }

    function renderAllocationChart(labels, data, colors) {
        const ctx = document.getElementById('allocationChart').getContext('2d');
        if (allocationChartInstance) allocationChartInstance.destroy();

        allocationChartInstance = new Chart(ctx, {
            type: 'doughnut',
            data: { labels: labels, datasets: [{ data: data, backgroundColor: colors, borderWidth: 1 }] },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
        });
    }

    function renderScenarioChart(baseReturn) {
        const ctx = document.getElementById('scenarioChart').getContext('2d');
        if (scenarioChartInstance) scenarioChartInstance.destroy();

        const optimistic = baseReturn * 1.35;
        const pessimistic = baseReturn * 0.65;

        scenarioChartInstance = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: ['Conservador', 'Base', 'Optimista'],
                datasets: [{
                    label: 'Retorno %',
                    data: [pessimistic, baseReturn, optimistic],
                    backgroundColor: ['#D62D20', '#002D5A', '#28a745'],
                    borderRadius: 4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: { y: { beginAtZero: true } },
                plugins: { legend: { display: false } }
            }
        });
    }

    // Inicio
    window.onload = generateProposal;

</script>

</body>
</html>